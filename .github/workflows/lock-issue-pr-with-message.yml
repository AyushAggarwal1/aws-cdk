name: Close issue message and lock closed PRs with message

on:
  pull_request_target:
    types: [closed]
  issues:
    types: [closed]

jobs:
  auto_comment:
    permissions:
      pull-requests: write
      issues: write
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/closed-issue-message@v1
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          message: |
            We appreciate you taking the time to provide feedback. However, It's hard for our team to track important updates in these closed discussions.
            If you have an ongoing question or need further assistance, please open a new issue and reference the original one. That will ensure we receive a notification and can better track and address your concerns.
  lock:
    permissions:
      pull-requests: write
      issues: write
    runs-on: ubuntu-latest
    needs: auto_comment # only run after comment is complete
    steps:
      - name: Lock closed issue or PR
        if: github.event_name == 'pull_request'
        run: |
          ISSUE_NUMBER=${{ github.event.pull_request.number }}
          ISSUE_URL=https://api.github.com/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/lock

          curl -s -X PUT -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          ${ISSUE_URL} \
          -d @- <<EOF
          {
            "lock_reason": "resolved"
          }
          EOF
